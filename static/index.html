<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seattle To Know</title>
    <!-- Google Maps will be loaded dynamically with API key from backend -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .weather-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .weather-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .weather-item .label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .weather-item .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .air-quality-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .air-quality-card {
                grid-template-columns: 1fr;
            }
        }

        .aqi-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 3px solid;
        }

        .aqi-display.green { border-color: #28a745; }
        .aqi-display.yellow { border-color: #ffc107; }
        .aqi-display.orange { border-color: #fd7e14; }
        .aqi-display.red { border-color: #dc3545; }
        .aqi-display.purple { border-color: #6f42c1; }

        .aqi-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .aqi-label {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .pollutants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .pollutant-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        .pollutant-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .pollutant-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .health-recommendations {
            margin-top: 20px;
        }

        .health-recommendations h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .health-recommendations ul {
            list-style: none;
            padding: 0;
        }

        .health-recommendations li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #e7f3ff;
            border-left: 3px solid #667eea;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .advice-list {
            list-style: none;
            padding: 0;
        }

        .advice-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }

        .what-to-know-sections {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .know-section {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        .know-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            background: #e9ecef;
            transition: background 0.2s;
            font-weight: 600;
            color: #667eea;
        }

        .know-section-header:hover {
            background: #dee2e6;
        }

        .know-more-btn {
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .know-section-content {
            padding: 15px;
            background: white;
        }

        .know-section-content.show {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 16px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section h3 {
            color: #667eea;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn.active {
            background: #667eea;
            color: white;
        }

        .time-range-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-range-btn {
            padding: 10px 20px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .time-range-btn.active {
            background: #764ba2;
            color: white;
        }

        .food-list, .events-list, .activities-list {
            display: grid;
            gap: 15px;
        }

        .food-list {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            max-width: 100%;
        }

        .food-map-container {
            width: 100%;
            height: 600px;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            background: #f0f0f0;
            transition: box-shadow 0.3s ease;
        }

        .food-map-container:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.18);
        }

        #food-map {
            width: 100%;
            height: 100%;
            min-height: 600px;
            border-radius: 16px;
        }

        @media (min-width: 768px) {
            .food-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .food-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .food-item, .event-card, .activity-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .food-item {
            padding: 12px 15px;
        }

        .food-item:hover, .event-card:hover, .activity-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .item-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .food-item .item-name {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .item-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .food-item .item-details {
            gap: 12px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .item-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .item-type {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .food-item .link-btn {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        .link-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 8px;
            transition: background 0.3s;
        }

        .link-btn:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .weather-overview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .weather-overview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .weather-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .weather-overview-item {
            text-align: center;
        }

        .weather-overview-item .label {
            font-size: 0.75rem;
            color: #666;
        }

        .weather-overview-item .value {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåßÔ∏è Seattle To Know</h1>
            <p>Your daily guide to Seattle</p>
        </div>

        <div id="overview-section" class="card">
            <div class="loading">Loading overview...</div>
        </div>

        <div class="card">
            <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">What are you looking for today?</h2>
            <div class="tabs">
                <button class="tab-btn" data-tab="food">üçï Food</button>
                <button class="tab-btn" data-tab="events">üéâ Events</button>
                <button class="tab-btn" data-tab="outdoor">üèÉ Outdoor Activities</button>
            </div>

            <div id="food-tab" class="tab-content">
                <div class="loading">Loading food options...</div>
            </div>

            <div id="events-tab" class="tab-content">
                <div class="loading">Loading events...</div>
            </div>

            <div id="outdoor-tab" class="tab-content">
                <div class="loading">Loading outdoor activities...</div>
            </div>
        </div>
    </div>

    <script>
        let cachedWeather = null;
        let cachedAirQuality = null;
        let selectedEventType = null;
        let selectedTimeRange = 'today';
        let selectedLocations = []; // Array to hold multiple selected locations
        let selectedPriceRange = null;
        let selectedActivityType = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Load tab content
                if (tabName === 'food') {
                    loadFood();
                } else if (tabName === 'events') {
                    loadEvents();
                } else if (tabName === 'outdoor') {
                    loadOutdoor();
                }
            });
        });

        // Load overview on page load
        async function loadOverview() {
            try {
                const response = await fetch('/api/overview');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                cachedWeather = data.weather;
                cachedAirQuality = data.air_quality;
                
                displayOverview(data);
            } catch (error) {
                document.getElementById('overview-section').innerHTML = `
                    <div class="error">
                        <strong>Error loading overview:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function displayOverview(data) {
            const html = `
                <h2 style="color: #667eea; margin-bottom: 20px;">üìÖ ${data.date} - ${data.city}</h2>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Weather</h3>
                <div class="weather-card">
                    <div class="weather-item">
                        <div class="label">Temperature</div>
                        <div class="value">${data.weather.temperature_c}¬∞C</div>
                    </div>
                    <div class="weather-item">
                        <div class="label">Feels Like</div>
                        <div class="value">${data.weather.feels_like_c}¬∞C</div>
                    </div>
                    <div class="weather-item">
                        <div class="label">Condition</div>
                        <div class="value">${data.weather.condition}</div>
                    </div>
                    <div class="weather-item">
                        <div class="label">Wind Speed</div>
                        <div class="value">${data.weather.wind_mph} mph</div>
                    </div>
                </div>

                ${data.air_quality.health_recommendations && data.air_quality.health_recommendations.length > 0 ? `
                    <div class="health-recommendations" style="margin-top: 20px;">
                        <h4>üí° Health Recommendations</h4>
                        <ul>
                            ${data.air_quality.health_recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${data.weather_forecast ? `
                    <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #667eea; border-radius: 8px;">
                        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1rem;">üå¶Ô∏è Weather Forecast (Next 2-3 Hours)</h4>
                        <div style="font-size: 0.95rem; margin-bottom: 10px; font-weight: 500;">
                            ${data.weather_forecast.forecast}
                        </div>
                        ${data.weather_forecast.next_hours && data.weather_forecast.next_hours.length > 0 ? `
                            <div style="display: grid; gap: 10px; margin-top: 10px;">
                                ${data.weather_forecast.next_hours.map(hour => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px;">
                                        <div>
                                            <strong>${hour.time}</strong>
                                            <span style="color: #666; margin-left: 8px;">${hour.condition}</span>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600; color: #667eea;">${hour.temperature_c}¬∞C</div>
                                            ${hour.will_rain ? `<div style="font-size: 0.8rem; color: #dc3545;">üåßÔ∏è ${hour.rain_probability}% rain</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 20px;">üå¨Ô∏è Air Quality & Health</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="aqi-display ${data.air_quality.aqi_color}">
                        <div class="aqi-label">Air Quality Index (US EPA)</div>
                        <div class="aqi-value" style="color: ${getAQIColor(data.air_quality.aqi_color)}">${data.air_quality.aqi}</div>
                        <div class="aqi-label" style="color: ${getAQIColor(data.air_quality.aqi_color)}">${data.air_quality.aqi_label}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">${data.air_quality.health_concern}</div>
                        ${data.air_quality.dominant_pollutant ? `<div style="font-size: 0.75rem; color: #888; margin-top: 5px;">Primary: ${data.air_quality.dominant_pollutant}</div>` : ''}
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 0.9rem;">üìä US EPA AQI Scale (0-500)</h4>
                        <div style="display: grid; gap: 6px; font-size: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #28a745; border: 2px solid #28a745;"></div>
                                <span><strong>0-50: Good</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #ffc107; border: 2px solid #ffc107;"></div>
                                <span><strong>51-100: Moderate</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #fd7e14; border: 2px solid #fd7e14;"></div>
                                <span><strong>101-150: Unhealthy for Sensitive Groups</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #dc3545; border: 2px solid #dc3545;"></div>
                                <span><strong>151-200: Unhealthy</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #6f42c1; border: 2px solid #6f42c1;"></div>
                                <span><strong>201-300: Very Unhealthy</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border-radius: 3px; background: #800020; border: 2px solid #800020;"></div>
                                <span><strong>301-500: Hazardous</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 0.95rem;">Pollutants (Œºg/m¬≥)</h4>
                    <div class="pollutants-grid">
                        <div class="pollutant-item">
                            <div class="pollutant-label">PM2.5</div>
                            <div class="pollutant-value">${data.air_quality.pollutants.pm2_5}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">PM10</div>
                            <div class="pollutant-value">${data.air_quality.pollutants.pm10}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">NO‚ÇÇ</div>
                            <div class="pollutant-value">${data.air_quality.pollutants.no2}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">O‚ÇÉ</div>
                            <div class="pollutant-value">${data.air_quality.pollutants.o3}</div>
                        </div>
                        <div class="pollutant-item">
                            <div class="pollutant-label">CO</div>
                            <div class="pollutant-value">${data.air_quality.pollutants.co}</div>
                        </div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 20px;">What To Know Today</h3>
                <div class="what-to-know-sections">
                    ${data.what_to_know_today.traffic && data.what_to_know_today.traffic.length > 0 ? `
                        <div class="know-section">
                            <div class="know-section-header" onclick="toggleKnowSection('traffic')">
                                <span>üö¶ Traffic Updates (${data.what_to_know_today.traffic.length})</span>
                                <span class="know-more-btn" id="traffic-toggle">‚ñº</span>
                            </div>
                            <div class="know-section-content" id="traffic-content" style="display: none;">
                                <ul class="advice-list">
                                    ${data.what_to_know_today.traffic.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <a href="https://www.wsdot.com/traffic/seattle/default.aspx" target="_blank" class="link-btn" style="margin-top: 10px;">üîó Know More - WSDOT Traffic</a>
                            </div>
                        </div>
                    ` : ''}
                    ${data.what_to_know_today.weather && data.what_to_know_today.weather.length > 0 ? `
                        <div class="know-section">
                            <div class="know-section-header" onclick="toggleKnowSection('weather')">
                                <span>üå§Ô∏è Weather Updates (${data.what_to_know_today.weather.length})</span>
                                <span class="know-more-btn" id="weather-toggle">‚ñº</span>
                            </div>
                            <div class="know-section-content" id="weather-content" style="display: none;">
                                <ul class="advice-list">
                                    ${data.what_to_know_today.weather.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <a href="https://weather.com/weather/today/l/Seattle+WA" target="_blank" class="link-btn" style="margin-top: 10px;">üîó Know More - Weather.com</a>
                            </div>
                        </div>
                    ` : ''}
                    ${data.what_to_know_today.air_quality && data.what_to_know_today.air_quality.length > 0 ? `
                        <div class="know-section">
                            <div class="know-section-header" onclick="toggleKnowSection('air_quality')">
                                <span>üå¨Ô∏è Air Quality Updates (${data.what_to_know_today.air_quality.length})</span>
                                <span class="know-more-btn" id="air_quality-toggle">‚ñº</span>
                            </div>
                            <div class="know-section-content" id="air_quality-content" style="display: none;">
                                <ul class="advice-list">
                                    ${data.what_to_know_today.air_quality.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <a href="https://www.airnow.gov/?city=Seattle&state=WA&country=USA" target="_blank" class="link-btn" style="margin-top: 10px;">üîó Know More - AirNow</a>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('overview-section').innerHTML = html;
        }

        function getAQIColor(color) {
            const colors = {
                'green': '#28a745',
                'yellow': '#ffc107',
                'orange': '#fd7e14',
                'red': '#dc3545',
                'purple': '#6f42c1',
                'maroon': '#800020'
            };
            return colors[color] || '#667eea';
        }

        async function loadFood() {
            const tab = document.getElementById('food-tab');
            tab.innerHTML = '<div class="loading">Loading food options...</div>';
            
            try {
                const params = new URLSearchParams();
                if (selectedPriceRange) params.append('price_range', selectedPriceRange);
                
                const response = await fetch(`/api/food?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                displayFood(data);
            } catch (error) {
                tab.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayFood(data) {
            const html = `
                ${displayWeatherOverview(data.weather, data.air_quality)}
                
                <div class="filter-section">
                    <h3>Filter by Price Range</h3>
                    <div class="button-group">
                        <button class="btn ${!selectedPriceRange ? 'active' : ''}" data-price="all">All Prices</button>
                        ${data.price_ranges.map(price => `
                            <button class="btn ${selectedPriceRange === price ? 'active' : ''}" data-price="${price}">${price}</button>
                        `).join('')}
                    </div>
                </div>

                <div class="food-map-container">
                    <div id="food-map" class="skeleton-map">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üó∫Ô∏è</div>
                            <div>Loading map...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('food-tab').innerHTML = html;
            
            // Always initialize map, even if no restaurants
            const restaurants = data.food_joints || [];
            console.log('Restaurants data:', restaurants.length);
            
            // Load Google Maps API if not already loaded, then initialize map
            if (!window.google || !window.google.maps) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.google_maps_api_key || ''}&libraries=places`;
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    console.log('Google Maps API loaded');
                    // Initialize map immediately for faster UX
                    setTimeout(() => {
                        console.log('Initializing map with', restaurants.length, 'restaurants');
                        initializeFoodMap(restaurants);
                    }, 100);
                };
                script.onerror = () => {
                    console.error('Failed to load Google Maps API');
                    const mapElement = document.getElementById('food-map');
                    if (mapElement) {
                        mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Failed to load map. Please check your Google Maps API key.</div>';
                    }
                };
                document.head.appendChild(script);
            } else {
                // Google Maps already loaded, initialize map immediately
                console.log('Google Maps already loaded');
                setTimeout(() => {
                    console.log('Initializing map with', restaurants.length, 'restaurants');
                    initializeFoodMap(restaurants);
                }, 100);
            }
            
            // Add event listeners for price range buttons
            document.querySelectorAll('#food-tab .btn[data-price]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#food-tab .btn[data-price]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedPriceRange = btn.dataset.price === 'all' ? null : btn.dataset.price;
                    loadFood();
                });
            });
        }

        let foodMap = null;
        let foodMarkers = [];

        function initializeFoodMap(restaurants) {
            const mapElement = document.getElementById('food-map');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }
            
            if (!window.google || !window.google.maps) {
                console.error('Google Maps API not loaded');
                mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Google Maps API not loaded. Please refresh the page.</div>';
                return;
            }
            
            // Center map on Seattle
            const seattleCenter = { lat: 47.6062, lng: -122.3321 };
            
            try {
                // Remove skeleton and clear loading message
                mapElement.classList.remove('skeleton-map');
                mapElement.innerHTML = '';
                
                // Initialize map with smooth appearance
                foodMap = new google.maps.Map(mapElement, {
                    zoom: 12,
                    center: seattleCenter,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ],
                    disableDefaultUI: false,
                    zoomControl: true,
                    mapTypeControl: false,
                    scaleControl: true,
                    streetViewControl: false,
                    rotateControl: false,
                    fullscreenControl: true
                });
                
                // Add fade-in effect
                mapElement.classList.add('fade-in');
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                mapElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">Error initializing map: ${error.message}</div>`;
                return;
            }

            // Place type color mapping (3 simple classifications)
            const placeTypeColors = {
                'Cafe': '#8B4513',
                'Bar': '#9B59B6',
                'Restaurant': '#667eea'
            };

            // Place type icons
            const placeTypeIcons = {
                'Cafe': '‚òï',
                'Bar': 'üç∫',
                'Restaurant': 'üçΩÔ∏è'
            };

            // Clear existing markers
            foodMarkers.forEach(marker => marker.setMap(null));
            foodMarkers = [];

            // Create markers for each place, color-coded by type
            if (!restaurants || restaurants.length === 0) {
                console.log('No places to display on map');
                return;
            }
            
            restaurants.forEach(restaurant => {
                if (!restaurant.lat || !restaurant.lng) {
                    console.warn('Place missing coordinates:', restaurant.name);
                    return;
                }

                const placeType = restaurant.cuisine || 'Restaurant';
                const color = placeTypeColors[placeType] || '#667eea';
                const icon = placeTypeIcons[placeType] || 'üçΩÔ∏è';

                // Create custom marker with cuisine color
                const marker = new google.maps.Marker({
                    position: { lat: restaurant.lat, lng: restaurant.lng },
                    map: foodMap,
                    title: restaurant.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: color,
                        fillOpacity: 0.8,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    },
                    label: {
                        text: icon,
                        fontSize: '14px'
                    }
                });

                // Create info window content with better styling
                const infoContent = `
                    <div style="padding: 0; min-width: 280px; max-width: 320px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        ${restaurant.photo_url ? `
                            <img src="${restaurant.photo_url}" alt="${restaurant.name}" 
                                 style="width: 100%; height: 180px; object-fit: cover; display: block; background: #f0f0f0;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.borderRadius='12px 12px 0 0';" />
                        ` : ''}
                        <div style="padding: 16px; background: white;">
                            <h3 style="margin: 0 0 10px 0; font-size: 1.2rem; color: #333; font-weight: 600; line-height: 1.3;">${restaurant.name}</h3>
                            <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                <span style="background: ${color}; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.3px;">${placeType}</span>
                                <span style="color: #28a745; font-weight: 600; font-size: 0.9rem;">${restaurant.price_range}</span>
                                ${restaurant.rating ? `<span style="color: #ffc107; font-size: 0.9rem; font-weight: 600;">‚≠ê ${restaurant.rating.toFixed(1)}</span>` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                                <span>üìç</span> <span>${restaurant.area || 'Seattle'}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 12px; line-height: 1.5;">${restaurant.address}</div>
                            <a href="${restaurant.google_maps_link}" target="_blank" 
                               style="display: block; padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 0.9rem; text-align: center; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"
                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                                üìç Open in Google Maps
                            </a>
                        </div>
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                marker.addListener('click', () => {
                    // Close all other info windows
                    foodMarkers.forEach(m => {
                        if (m.infoWindow) m.infoWindow.close();
                    });
                    infoWindow.open(foodMap, marker);
                    marker.infoWindow = infoWindow;
                });

                foodMarkers.push(marker);
            });

            // Fit map to show all markers
            if (foodMarkers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                foodMarkers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                foodMap.fitBounds(bounds);
                
                // Don't zoom in too much if there are many markers
                if (foodMap.getZoom() > 14) {
                    foodMap.setZoom(14);
                }
            }
        }

        async function loadEvents() {
            const tab = document.getElementById('events-tab');
            tab.innerHTML = '<div class="loading">Loading events...</div>';
            
            try {
                const params = new URLSearchParams();
                if (selectedEventType) params.append('event_type', selectedEventType);
                params.append('time_range', selectedTimeRange);
                if (selectedLocations.length > 0) {
                    params.append('locations', selectedLocations.join(','));
                }
                params.append('event_limit', '20');
                
                const response = await fetch(`/api/events?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                displayEvents(data);
            } catch (error) {
                tab.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayEvents(data) {
            const html = `
                ${displayWeatherOverview(data.weather, data.air_quality)}
                
                <div class="time-range-toggle">
                    <button class="time-range-btn ${selectedTimeRange === 'today' ? 'active' : ''}" data-range="today">Today</button>
                    <button class="time-range-btn ${selectedTimeRange === 'tomorrow' ? 'active' : ''}" data-range="tomorrow">Tomorrow</button>
                    <button class="time-range-btn ${selectedTimeRange === 'week' ? 'active' : ''}" data-range="week">This Week</button>
                </div>

                <div class="filter-section">
                    <h3>Location</h3>
                    <div class="button-group">
                        <button class="btn ${selectedLocations.length === 0 ? 'active' : ''}" data-location="all">All Locations</button>
                        ${data.locations && data.locations.length > 0 ? data.locations.map(location => `
                            <button class="btn ${selectedLocations.includes(location) ? 'active' : ''}" data-location="${location}">üìç ${location}</button>
                        `).join('') : '<div style="color: #666; font-size: 0.9rem; padding: 10px;">Loading locations...</div>'}
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Event Type</h3>
                    <div class="button-group">
                        <button class="btn ${!selectedEventType ? 'active' : ''}" data-type="all">All Events</button>
                        <button class="btn ${selectedEventType === 'music' ? 'active' : ''}" data-type="music">üéµ Music</button>
                        <button class="btn ${selectedEventType === 'food' ? 'active' : ''}" data-type="food">üçï Food</button>
                        <button class="btn ${selectedEventType === 'sports' ? 'active' : ''}" data-type="sports">‚öΩ Sports</button>
                        <button class="btn ${selectedEventType === 'tech' ? 'active' : ''}" data-type="tech">üíª Tech</button>
                        <button class="btn ${selectedEventType === 'arts' ? 'active' : ''}" data-type="arts">üé® Arts</button>
                        <button class="btn ${selectedEventType === 'business' ? 'active' : ''}" data-type="business">üíº Business</button>
                        <button class="btn ${selectedEventType === 'comedy' ? 'active' : ''}" data-type="comedy">üòÇ Comedy</button>
                    </div>
                </div>

                <div class="events-list">
                    ${data.events.length > 0 ? data.events.map(event => `
                        <div class="event-card">
                            <div class="item-name">${event.name}</div>
                            <div class="item-details">
                                ${event.date && event.date.trim && event.date.trim() ? `<div class="item-detail">üìÖ ${event.date}</div>` : ''}
                                ${event.time && event.time.trim && event.time.trim() ? `<div class="item-detail">üïê ${event.time}</div>` : ''}
                                ${event.area ? `<div class="item-detail">üìç ${event.area}</div>` : ''}
                                ${event.type ? `<span class="item-type">${event.type}</span>` : ''}
                            </div>
                            ${event.url ? `<a href="${event.url}" target="_blank" class="link-btn" style="margin-top: 10px;">üîó Know More</a>` : ''}
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>No events found for the selected filters.</p>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('events-tab').innerHTML = html;
            
            // Add event listeners
            document.querySelectorAll('#events-tab .time-range-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#events-tab .time-range-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedTimeRange = btn.dataset.range;
                    loadEvents();
                });
            });
            
            document.querySelectorAll('#events-tab .btn[data-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#events-tab .btn[data-type]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedEventType = btn.dataset.type === 'all' ? null : btn.dataset.type;
                    loadEvents();
                });
            });
            
            // Add event listeners for location filters (multi-select)
            document.querySelectorAll('#events-tab .btn[data-location]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const location = btn.dataset.location;
                    if (location === 'all') {
                        // Clear all selections
                        selectedLocations = [];
                        document.querySelectorAll('#events-tab .btn[data-location]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    } else {
                        // Toggle location selection (multi-select enabled)
                        const index = selectedLocations.indexOf(location);
                        if (index > -1) {
                            // Remove from selection
                            selectedLocations.splice(index, 1);
                            btn.classList.remove('active');
                        } else {
                            // Add to selection (allows multiple)
                            selectedLocations.push(location);
                            btn.classList.add('active');
                        }
                        // Update "All Locations" button
                        const allBtn = document.querySelector('#events-tab .btn[data-location="all"]');
                        if (allBtn) {
                            if (selectedLocations.length === 0) {
                                allBtn.classList.add('active');
                            } else {
                                allBtn.classList.remove('active');
                            }
                        }
                    }
                    loadEvents();
                });
            });
        }

        async function loadOutdoor() {
            const tab = document.getElementById('outdoor-tab');
            tab.innerHTML = '<div class="loading">Loading outdoor activities...</div>';
            
            try {
                const params = new URLSearchParams();
                if (selectedActivityType) params.append('activity_type', selectedActivityType);
                
                const response = await fetch(`/api/outdoor?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                displayOutdoor(data);
            } catch (error) {
                tab.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayOutdoor(data) {
            const html = `
                ${displayWeatherOverview(data.weather, data.air_quality)}
                
                <div class="filter-section">
                    <h3>Activity Type</h3>
                    <div class="button-group">
                        <button class="btn ${!selectedActivityType ? 'active' : ''}" data-activity="all">All Activities</button>
                        ${data.activity_types.map(type => `
                            <button class="btn ${selectedActivityType === type ? 'active' : ''}" data-activity="${type}">${type}</button>
                        `).join('')}
                    </div>
                </div>

                <div class="activities-list">
                    ${data.activities.map(activity => `
                        <div class="activity-card">
                            <div class="item-name">${activity.name}</div>
                            <div class="item-details">
                                <div class="item-detail">üìç ${activity.location}</div>
                                <span class="item-type">${activity.type}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">${activity.address}</div>
                            <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                                ${activity.rules_link ? `<a href="${activity.rules_link}" target="_blank" class="link-btn">üìñ Official Rules</a>` : ''}
                                <a href="${activity.google_maps_link}" target="_blank" class="link-btn">üìç Google Maps</a>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('outdoor-tab').innerHTML = html;
            
            // Add event listeners
            document.querySelectorAll('#outdoor-tab .btn[data-activity]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#outdoor-tab .btn[data-activity]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedActivityType = btn.dataset.activity === 'all' ? null : btn.dataset.activity;
                    loadOutdoor();
                });
            });
        }

        function displayWeatherOverview(weather, airQuality) {
            if (!weather || !airQuality) return '';
            
            return `
                <div class="weather-overview">
                    <h4>Weather Overview</h4>
                    <div class="weather-overview-grid">
                        <div class="weather-overview-item">
                            <div class="label">Temp</div>
                            <div class="value">${weather.temperature_c}¬∞C</div>
                        </div>
                        <div class="weather-overview-item">
                            <div class="label">Condition</div>
                            <div class="value">${weather.condition}</div>
                        </div>
                        <div class="weather-overview-item">
                            <div class="label">Air Quality</div>
                            <div class="value">${airQuality.aqi_label}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load overview on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadOverview();
            // Set first tab as active and load it
            document.querySelector('.tab-btn[data-tab="food"]').classList.add('active');
            document.getElementById('food-tab').classList.add('active');
            loadFood();
        });
        function toggleKnowSection(section) {
            const content = document.getElementById(`${section}-content`);
            const toggle = document.getElementById(`${section}-toggle`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
    </script>
</body>
</html>
